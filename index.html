<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slider Editor - AquaVentus</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      min-height: 100vh;
    }

    /* Header */
    .editor-header {
      background: #003366;
      color: #fff;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .editor-header h1 {
      font-size: 1.4rem;
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #0099cc;
      color: #fff;
    }

    .btn-primary:hover {
      background: #007aa3;
    }

    .btn-success {
      background: #28a745;
      color: #fff;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-secondary {
      background: #fff;
      color: #003366;
    }

    .btn-secondary:hover {
      background: #e8f4f8;
    }

    .btn-danger {
      background: #dc3545;
      color: #fff;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    /* Main Layout */
    .editor-main {
      display: flex;
      height: calc(100vh - 60px);
    }

    /* Sidebar - Slide List */
    .sidebar {
      width: 280px;
      background: #fff;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-header h2 {
      font-size: 1rem;
      color: #333;
    }

    .slide-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .slide-item {
      background: #f8f9fa;
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .slide-item:hover {
      background: #e8f4f8;
    }

    .slide-item.active {
      border-color: #0099cc;
      background: #e8f4f8;
    }

    .slide-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .slide-item-number {
      background: #003366;
      color: #fff;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .slide-item-actions {
      display: flex;
      gap: 5px;
    }

    .slide-item-actions button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      color: #666;
      font-size: 1rem;
    }

    .slide-item-actions button:hover {
      background: #ddd;
    }

    .slide-item-title {
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .slide-item-preview {
      font-size: 0.8rem;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Editor Panel */
    .editor-panel {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      background: #f0f2f5;
    }

    .editor-card {
      background: #fff;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .editor-card h3 {
      color: #003366;
      font-size: 1.1rem;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e8f4f8;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.95rem;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #0099cc;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-group small {
      display: block;
      margin-top: 5px;
      color: #888;
      font-size: 0.8rem;
    }

    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .image-preview {
      margin-top: 10px;
      border-radius: 8px;
      overflow: hidden;
      background: #f0f0f0;
      max-height: 200px;
    }

    .image-preview img,
    .image-preview video {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
    }

    .image-preview-placeholder {
      height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 0.9rem;
    }

    /* Preview Panel */
    .preview-panel {
      width: 450px;
      background: #1a1a1a;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .preview-header {
      color: #fff;
      font-size: 0.9rem;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .preview-container {
      flex: 1;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      background: #000;
    }

    /* Mini Slider Preview */
    .mini-slider {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .mini-slide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      transition: opacity 0.5s;
    }

    .mini-slide.active {
      opacity: 1;
    }

    .mini-slide-image,
    .mini-slide-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Media Type Selector */
    .media-type-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .media-type-btn {
      flex: 1;
      padding: 12px 20px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      color: #666;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .media-type-btn:hover {
      border-color: #0099cc;
      color: #0099cc;
    }

    .media-type-btn.active {
      border-color: #0099cc;
      background: #e8f4f8;
      color: #003366;
    }

    .media-type-icon {
      font-size: 1.2rem;
    }

    .mini-slide-content {
      position: absolute;
      bottom: 40px;
      left: 15px;
      max-width: 70%;
      z-index: 10;
    }

    .mini-slide-title {
      background: #fff;
      color: #003366;
      padding: 8px 12px;
      font-size: 0.9rem;
      font-weight: 700;
      display: inline-block;
    }

    .mini-slide-desc {
      background: rgba(0, 40, 80, 0.85);
      color: #fff;
      padding: 10px 12px;
      font-size: 0.7rem;
      line-height: 1.5;
    }

    .mini-slide-button {
      display: inline-block;
      background: #0099cc;
      color: #fff;
      padding: 6px 14px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-top: 8px;
      border-radius: 4px;
      text-decoration: none;
    }

    /* Parallax Layers Preview */
    .mini-slide-layers {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .mini-slide-layer {
      position: absolute;
      top: -5%;
      left: -5%;
      width: 110%;
      height: 110%;
      object-fit: cover;
      transition: transform 0.1s ease-out;
    }

    /* Layer Input Styles */
    .layer-inputs {
      display: none;
    }

    .layer-inputs.active {
      display: block;
    }

    .layer-input-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #0099cc;
    }

    .layer-input-group.layer-1 { border-left-color: #003366; }
    .layer-input-group.layer-2 { border-left-color: #0066cc; }
    .layer-input-group.layer-3 { border-left-color: #0099cc; }
    .layer-input-group.layer-4 { border-left-color: #00cccc; }
    .layer-input-group.layer-5 { border-left-color: #00cc99; }

    .layer-label {
      min-width: 100px;
      font-weight: 600;
      color: #333;
      font-size: 0.85rem;
    }

    .layer-label small {
      display: block;
      font-weight: normal;
      color: #888;
      font-size: 0.75rem;
    }

    .layer-input-group input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .layer-input-group input:focus {
      outline: none;
      border-color: #0099cc;
    }

    .layer-depth-info {
      background: #e8f4f8;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 0.85rem;
      color: #333;
    }

    .layer-depth-info strong {
      color: #003366;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 30px;
      color: #666;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      margin-bottom: 10px;
      color: #333;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal h2 {
      margin-bottom: 20px;
      color: #003366;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    /* Code Output */
    .code-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.8rem;
      max-height: 400px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #28a745;
      color: #fff;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 2000;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="editor-header">
    <h1>üé† Slider Editor</h1>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="showLoadModal()">üìÇ Laden</button>
      <button class="btn btn-secondary" onclick="showSaveModal()">üíæ Speichern</button>
      <button class="btn btn-success" onclick="showExportModal()">üìã HTML exportieren</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="editor-main">

    <!-- Sidebar: Slide List -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>Slides</h2>
        <button class="btn btn-primary btn-small" onclick="addSlide()">+ Neue Slide</button>
      </div>
      <div class="slide-list" id="slideList">
        <!-- Slides werden hier dynamisch eingef√ºgt -->
      </div>
    </aside>

    <!-- Editor Panel -->
    <section class="editor-panel" id="editorPanel">
      <div class="empty-state" id="emptyState">
        <div class="empty-state-icon">üé®</div>
        <h3>Keine Slide ausgew√§hlt</h3>
        <p>W√§hle eine Slide aus der Liste oder erstelle eine neue.</p>
      </div>

      <div id="slideEditor" style="display: none;">
        <!-- Inhalt -->
        <div class="editor-card">
          <h3>üìù Inhalt</h3>
          <div class="form-group">
            <label>Titel</label>
            <input type="text" id="slideTitle" placeholder="z.B. Zukunft erleben" oninput="updateSlide()">
          </div>
          <div class="form-group">
            <label>Beschreibung</label>
            <textarea id="slideDescription" placeholder="Beschreibungstext f√ºr die Slide..." oninput="updateSlide()"></textarea>
          </div>
        </div>

        <!-- Medien -->
        <div class="editor-card">
          <h3>üé¨ Hintergrund-Medien</h3>

          <div class="media-type-selector">
            <button type="button" class="media-type-btn active" id="mediaTypeImage" onclick="setMediaType('image')">
              <span class="media-type-icon">üñºÔ∏è</span> Bild
            </button>
            <button type="button" class="media-type-btn" id="mediaTypeVideo" onclick="setMediaType('video')">
              <span class="media-type-icon">üé•</span> Video
            </button>
            <button type="button" class="media-type-btn" id="mediaTypeParallax" onclick="setMediaType('parallax')">
              <span class="media-type-icon">üé≠</span> Parallax
            </button>
          </div>

          <!-- Single Image/Video Input -->
          <div id="singleMediaInput">
            <div class="form-group">
              <label id="mediaUrlLabel">Bild-URL</label>
              <input type="text" id="slideImage" placeholder="https://aquaventus.org/wp-content/uploads/..." oninput="updateSlide()">
              <small id="mediaUrlHint">Kopiere die URL aus der WordPress-Mediathek</small>
            </div>
            <div class="image-preview" id="imagePreview">
              <div class="image-preview-placeholder">Medienvorschau</div>
            </div>
          </div>

          <!-- Parallax Layers Input -->
          <div id="parallaxLayersInput" class="layer-inputs">
            <div class="layer-depth-info">
              <strong>Parallax-Ebenen:</strong> Lade bis zu 5 PNG-Ebenen hoch.
              Ebene 1 ist der Hintergrund (bewegt sich am langsamsten),
              Ebene 5 ist der Vordergrund (bewegt sich am schnellsten).
              Leere Ebenen werden √ºbersprungen.
            </div>

            <div class="layer-input-group layer-1">
              <div class="layer-label">Ebene 1<small>Hintergrund</small></div>
              <input type="text" id="layer1" placeholder="https://...bg.png" oninput="updateSlide()">
            </div>

            <div class="layer-input-group layer-2">
              <div class="layer-label">Ebene 2<small>Hinten</small></div>
              <input type="text" id="layer2" placeholder="https://...layer2.png" oninput="updateSlide()">
            </div>

            <div class="layer-input-group layer-3">
              <div class="layer-label">Ebene 3<small>Mitte</small></div>
              <input type="text" id="layer3" placeholder="https://...layer3.png" oninput="updateSlide()">
            </div>

            <div class="layer-input-group layer-4">
              <div class="layer-label">Ebene 4<small>Vorne</small></div>
              <input type="text" id="layer4" placeholder="https://...layer4.png" oninput="updateSlide()">
            </div>

            <div class="layer-input-group layer-5">
              <div class="layer-label">Ebene 5<small>Vordergrund</small></div>
              <input type="text" id="layer5" placeholder="https://...fg.png" oninput="updateSlide()">
            </div>

            <div class="image-preview" id="layersPreview">
              <div class="image-preview-placeholder">Ebenen-Vorschau</div>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="editor-card">
          <h3>üîó Buttons</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Button 1 Text</label>
              <input type="text" id="slideButton1Text" placeholder="z.B. Mehr erfahren" oninput="updateSlide()">
            </div>
            <div class="form-group">
              <label>Button 1 Link</label>
              <input type="text" id="slideButton1Link" placeholder="https://..." oninput="updateSlide()">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Button 2 Text (optional)</label>
              <input type="text" id="slideButton2Text" placeholder="z.B. Kontakt" oninput="updateSlide()">
            </div>
            <div class="form-group">
              <label>Button 2 Link</label>
              <input type="text" id="slideButton2Link" placeholder="https://..." oninput="updateSlide()">
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Preview Panel -->
    <aside class="preview-panel">
      <div class="preview-header">
        <span>Live-Vorschau</span>
      </div>
      <div class="preview-container" id="previewContainer">
        <div class="mini-slider" id="miniSlider">
          <div class="image-preview-placeholder" style="height:100%;color:#666;">
            F√ºge Slides hinzu f√ºr die Vorschau
          </div>
        </div>
      </div>
    </aside>

  </main>

  <!-- Export Modal -->
  <div class="modal-overlay" id="exportModal">
    <div class="modal">
      <h2>HTML-Code exportieren</h2>
      <p style="margin-bottom:15px;color:#666;">Kopiere diesen Code und f√ºge ihn in das Custom HTML Widget in Elementor ein:</p>
      <div class="code-output" id="codeOutput"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeExportModal()">Schlie√üen</button>
        <button class="btn btn-primary" onclick="copyCode()">üìã Code kopieren</button>
        <button class="btn btn-success" onclick="downloadCode()">üíæ Als Datei speichern</button>
      </div>
    </div>
  </div>

  <!-- Load Modal -->
  <div class="modal-overlay" id="loadModal">
    <div class="modal">
      <h2>üìÇ Projekt laden</h2>

      <div style="margin-bottom:20px;">
        <h3 style="font-size:1rem;margin-bottom:10px;color:#003366;">Aus Browser-Speicher laden</h3>
        <p style="color:#666;font-size:0.9rem;margin-bottom:10px;">Lade dein zuletzt gespeichertes Projekt:</p>
        <button class="btn btn-primary" onclick="loadFromStorageAndClose()">üíæ Gespeichertes Projekt laden</button>
      </div>

      <hr style="border:none;border-top:1px solid #eee;margin:20px 0;">

      <div>
        <h3 style="font-size:1rem;margin-bottom:10px;color:#003366;">Aus Datei laden</h3>
        <p style="color:#666;font-size:0.9rem;margin-bottom:10px;">Lade ein exportiertes JSON-Projekt oder eine CSV-Datei:</p>
        <input type="file" id="fileInput" accept=".json,.csv" style="display:none;" onchange="handleFileLoad(event)">
        <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">üìÑ Datei ausw√§hlen (.json / .csv)</button>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeLoadModal()">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- Save Modal -->
  <div class="modal-overlay" id="saveModal">
    <div class="modal">
      <h2>üíæ Projekt speichern</h2>

      <div style="margin-bottom:20px;">
        <h3 style="font-size:1rem;margin-bottom:10px;color:#003366;">Im Browser speichern</h3>
        <p style="color:#666;font-size:0.9rem;margin-bottom:10px;">Speichert automatisch im Browser (bleibt auch nach Schlie√üen erhalten):</p>
        <button class="btn btn-primary" onclick="saveToStorageAndClose()">üíæ Im Browser speichern</button>
      </div>

      <hr style="border:none;border-top:1px solid #eee;margin:20px 0;">

      <div>
        <h3 style="font-size:1rem;margin-bottom:10px;color:#003366;">Als Datei exportieren</h3>
        <p style="color:#666;font-size:0.9rem;margin-bottom:10px;">Speichere das Projekt als Datei zum Teilen oder Backup:</p>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn btn-secondary" onclick="downloadProjectJSON()">üìÑ Als JSON speichern</button>
          <button class="btn btn-secondary" onclick="downloadProjectCSV()">üìä Als CSV speichern</button>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeSaveModal()">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">Gespeichert!</div>

  <script>
    // Slide-Daten
    let slides = [];
    let currentSlideIndex = -1;

    // Initialisierung
    document.addEventListener('DOMContentLoaded', () => {
      loadFromStorage();
      if (slides.length === 0) {
        // Demo-Slide hinzuf√ºgen
        addSlide();
      }

      // Preview parallax effect
      setupPreviewParallax();
    });

    // Setup preview parallax mouse tracking
    function setupPreviewParallax() {
      const container = document.getElementById('previewContainer');
      container.addEventListener('mousemove', (e) => {
        const rect = container.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width - 0.5;
        const y = (e.clientY - rect.top) / rect.height - 0.5;

        // Apply parallax to layers in preview
        const layers = container.querySelectorAll('.mini-slide.active .mini-slide-layer');
        layers.forEach((layer, index) => {
          const depth = (index + 1) * 0.15; // Increasing depth for each layer
          const moveX = x * 30 * depth;
          const moveY = y * 20 * depth;
          layer.style.transform = `translate(${moveX}px, ${moveY}px)`;
        });

      });

      container.addEventListener('mouseleave', () => {
        const layers = container.querySelectorAll('.mini-slide-layer');
        layers.forEach(layer => {
          layer.style.transform = 'translate(0, 0)';
        });
      });
    }

    // Slide hinzuf√ºgen
    function addSlide() {
      const newSlide = {
        id: Date.now(),
        title: 'Neue Slide',
        description: '',
        image: '',
        mediaType: 'image',
        layers: ['', '', '', '', ''],
        button1Text: 'Mehr erfahren',
        button1Link: '',
        button2Text: '',
        button2Link: ''
      };
      slides.push(newSlide);
      renderSlideList();
      selectSlide(slides.length - 1);
      updatePreview();
    }

    // Slide ausw√§hlen
    function selectSlide(index) {
      currentSlideIndex = index;
      renderSlideList();

      if (index >= 0 && index < slides.length) {
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('slideEditor').style.display = 'block';
        loadSlideToEditor(slides[index]);
      } else {
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('slideEditor').style.display = 'none';
      }
    }

    // Slide in Editor laden
    function loadSlideToEditor(slide) {
      document.getElementById('slideTitle').value = slide.title || '';
      document.getElementById('slideDescription').value = slide.description || '';
      document.getElementById('slideImage').value = slide.image || '';
      document.getElementById('slideButton1Text').value = slide.button1Text || '';
      document.getElementById('slideButton1Link').value = slide.button1Link || '';
      document.getElementById('slideButton2Text').value = slide.button2Text || '';
      document.getElementById('slideButton2Link').value = slide.button2Link || '';

      // Load layers
      const layers = slide.layers || ['', '', '', '', ''];
      for (let i = 1; i <= 5; i++) {
        document.getElementById('layer' + i).value = layers[i - 1] || '';
      }

      // Media Type setzen
      const mediaType = slide.mediaType || 'image';
      setMediaType(mediaType, false);

      if (mediaType === 'parallax') {
        updateLayersPreview(layers);
      } else {
        updateMediaPreview(slide.image, mediaType);
      }
    }

    // Media Type wechseln
    function setMediaType(type, shouldUpdate = true) {
      const imageBtn = document.getElementById('mediaTypeImage');
      const videoBtn = document.getElementById('mediaTypeVideo');
      const parallaxBtn = document.getElementById('mediaTypeParallax');
      const singleMediaInput = document.getElementById('singleMediaInput');
      const parallaxLayersInput = document.getElementById('parallaxLayersInput');
      const urlLabel = document.getElementById('mediaUrlLabel');
      const urlHint = document.getElementById('mediaUrlHint');
      const urlInput = document.getElementById('slideImage');

      // Reset all buttons
      imageBtn.classList.remove('active');
      videoBtn.classList.remove('active');
      parallaxBtn.classList.remove('active');

      if (type === 'video') {
        videoBtn.classList.add('active');
        singleMediaInput.style.display = 'block';
        parallaxLayersInput.classList.remove('active');
        urlLabel.textContent = 'Video-URL';
        urlHint.textContent = 'Unterst√ºtzte Formate: MP4, WebM. Kopiere die URL aus der WordPress-Mediathek.';
        urlInput.placeholder = 'https://aquaventus.org/wp-content/uploads/...video.mp4';
      } else if (type === 'parallax') {
        parallaxBtn.classList.add('active');
        singleMediaInput.style.display = 'none';
        parallaxLayersInput.classList.add('active');
      } else {
        imageBtn.classList.add('active');
        singleMediaInput.style.display = 'block';
        parallaxLayersInput.classList.remove('active');
        urlLabel.textContent = 'Bild-URL';
        urlHint.textContent = 'Kopiere die URL aus der WordPress-Mediathek';
        urlInput.placeholder = 'https://aquaventus.org/wp-content/uploads/...';
      }

      if (shouldUpdate && currentSlideIndex >= 0) {
        slides[currentSlideIndex].mediaType = type;
        if (type === 'parallax') {
          updateLayersPreview(slides[currentSlideIndex].layers || []);
        } else {
          updateMediaPreview(slides[currentSlideIndex].image, type);
        }
        updatePreview();
      }
    }

    // Slide aktualisieren
    function updateSlide() {
      if (currentSlideIndex < 0) return;

      const mediaType = document.getElementById('mediaTypeParallax').classList.contains('active') ? 'parallax' :
                        document.getElementById('mediaTypeVideo').classList.contains('active') ? 'video' : 'image';

      // Get layers
      const layers = [];
      for (let i = 1; i <= 5; i++) {
        layers.push(document.getElementById('layer' + i).value);
      }

      slides[currentSlideIndex] = {
        ...slides[currentSlideIndex],
        title: document.getElementById('slideTitle').value,
        description: document.getElementById('slideDescription').value,
        image: document.getElementById('slideImage').value,
        mediaType: mediaType,
        layers: layers,
        button1Text: document.getElementById('slideButton1Text').value,
        button1Link: document.getElementById('slideButton1Link').value,
        button2Text: document.getElementById('slideButton2Text').value,
        button2Link: document.getElementById('slideButton2Link').value
      };

      if (mediaType === 'parallax') {
        updateLayersPreview(layers);
      } else {
        updateMediaPreview(slides[currentSlideIndex].image, mediaType);
      }
      renderSlideList();
      updatePreview();
    }

    // Medienvorschau aktualisieren
    function updateMediaPreview(url, mediaType) {
      const preview = document.getElementById('imagePreview');
      if (url && url.trim()) {
        if (mediaType === 'video') {
          preview.innerHTML = `<video src="${url}" autoplay loop muted playsinline onerror="this.parentElement.innerHTML='<div class=\\'image-preview-placeholder\\'>Video konnte nicht geladen werden</div>'"></video>`;
        } else {
          preview.innerHTML = `<img src="${url}" alt="Vorschau" onerror="this.parentElement.innerHTML='<div class=\\'image-preview-placeholder\\'>Bild konnte nicht geladen werden</div>'">`;
        }
      } else {
        preview.innerHTML = '<div class="image-preview-placeholder">Medienvorschau</div>';
      }
    }

    // Layers preview
    function updateLayersPreview(layers) {
      const preview = document.getElementById('layersPreview');
      const filledLayers = layers.filter(l => l && l.trim());

      if (filledLayers.length === 0) {
        preview.innerHTML = '<div class="image-preview-placeholder">Ebenen-Vorschau (mindestens eine Ebene ben√∂tigt)</div>';
        return;
      }

      let html = '<div style="position:relative;width:100%;height:200px;overflow:hidden;">';
      layers.forEach((layer, index) => {
        if (layer && layer.trim()) {
          html += `<img src="${layer}" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:${index + 1};" onerror="this.style.display='none'">`;
        }
      });
      html += '</div>';
      preview.innerHTML = html;
    }

    // Slide-Liste rendern
    function renderSlideList() {
      const list = document.getElementById('slideList');

      if (slides.length === 0) {
        list.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine Slides vorhanden</div>';
        return;
      }

      list.innerHTML = slides.map((slide, index) => {
        let typeIcon = 'üñºÔ∏è';
        if (slide.mediaType === 'video') typeIcon = 'üé•';
        else if (slide.mediaType === 'parallax') typeIcon = 'üé≠';

        return `
        <div class="slide-item ${index === currentSlideIndex ? 'active' : ''}" onclick="selectSlide(${index})">
          <div class="slide-item-header">
            <span class="slide-item-number">${index + 1}</span>
            <div class="slide-item-actions">
              <button onclick="event.stopPropagation(); moveSlide(${index}, -1)" title="Nach oben" ${index === 0 ? 'disabled style="opacity:0.3"' : ''}>‚Üë</button>
              <button onclick="event.stopPropagation(); moveSlide(${index}, 1)" title="Nach unten" ${index === slides.length - 1 ? 'disabled style="opacity:0.3"' : ''}>‚Üì</button>
              <button onclick="event.stopPropagation(); duplicateSlide(${index})" title="Duplizieren">üìã</button>
              <button onclick="event.stopPropagation(); deleteSlide(${index})" title="L√∂schen" style="color:#dc3545">üóëÔ∏è</button>
            </div>
          </div>
          <div class="slide-item-title">${typeIcon} ${slide.title || 'Ohne Titel'}</div>
          <div class="slide-item-preview">${slide.description ? slide.description.substring(0, 40) + '...' : 'Keine Beschreibung'}</div>
        </div>
      `}).join('');
    }

    // Slide l√∂schen
    function deleteSlide(index) {
      if (slides.length === 1) {
        showToast('Mindestens eine Slide erforderlich');
        return;
      }
      if (confirm('Slide wirklich l√∂schen?')) {
        slides.splice(index, 1);
        if (currentSlideIndex >= slides.length) {
          currentSlideIndex = slides.length - 1;
        }
        renderSlideList();
        selectSlide(currentSlideIndex);
        updatePreview();
      }
    }

    // Slide duplizieren
    function duplicateSlide(index) {
      const copy = { ...slides[index], id: Date.now(), layers: [...(slides[index].layers || [])] };
      copy.title = copy.title + ' (Kopie)';
      slides.splice(index + 1, 0, copy);
      renderSlideList();
      selectSlide(index + 1);
      updatePreview();
    }

    // Slide verschieben
    function moveSlide(index, direction) {
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= slides.length) return;

      [slides[index], slides[newIndex]] = [slides[newIndex], slides[index]];
      currentSlideIndex = newIndex;
      renderSlideList();
      updatePreview();
    }

    // Live-Vorschau aktualisieren
    function updatePreview() {
      const container = document.getElementById('miniSlider');

      if (slides.length === 0) {
        container.innerHTML = '<div class="image-preview-placeholder" style="height:100%;color:#666;">F√ºge Slides hinzu f√ºr die Vorschau</div>';
        return;
      }

      container.innerHTML = slides.map((slide, index) => {
        let mediaHTML = '<div style="width:100%;height:100%;background:#333;"></div>';

        if (slide.mediaType === 'parallax') {
          const layers = slide.layers || [];
          const filledLayers = layers.filter(l => l && l.trim());
          if (filledLayers.length > 0) {
            mediaHTML = '<div class="mini-slide-layers">';
            layers.forEach((layer, i) => {
              if (layer && layer.trim()) {
                mediaHTML += `<img src="${layer}" class="mini-slide-layer" style="z-index:${i + 1};" alt="">`;
              }
            });
            mediaHTML += '</div>';
          }
        } else if (slide.image) {
          if (slide.mediaType === 'video') {
            mediaHTML = `<video src="${slide.image}" class="mini-slide-video" autoplay loop muted playsinline></video>`;
          } else {
            mediaHTML = `<img src="${slide.image}" class="mini-slide-image" alt="">`;
          }
        }

        return `
        <div class="mini-slide ${index === currentSlideIndex ? 'active' : ''}">
          ${mediaHTML}
          <div class="mini-slide-content">
            <div class="mini-slide-title">${slide.title || 'Titel'}</div>
            ${slide.description ? `<div class="mini-slide-desc">${slide.description.substring(0, 100)}${slide.description.length > 100 ? '...' : ''}</div>` : ''}
            ${slide.button1Text ? `<span class="mini-slide-button">${slide.button1Text}</span>` : ''}
          </div>
        </div>
      `;
      }).join('');
    }

    // In LocalStorage speichern
    function saveToStorage() {
      localStorage.setItem('aquaventus_slides', JSON.stringify(slides));
      showToast('Gespeichert!');
    }

    // Aus LocalStorage laden
    function loadFromStorage() {
      const saved = localStorage.getItem('aquaventus_slides');
      if (saved) {
        try {
          slides = JSON.parse(saved);
          // Backwards compatibility
          slides = slides.map(slide => ({
            ...slide,
            mediaType: slide.mediaType || 'image',
            layers: slide.layers || ['', '', '', '', '']
          }));
          renderSlideList();
          if (slides.length > 0) {
            selectSlide(0);
          }
          updatePreview();
        } catch (e) {
          console.error('Fehler beim Laden:', e);
        }
      }
    }

    // HTML-Code generieren
    function generateHTML() {
      // Dots generieren
      let dotsHTML = '';
      slides.forEach((_, i) => {
        dotsHTML += `      <button class="hero-dot${i === 0 ? ' active' : ''}" onclick="goToSlideManual(${i})"></button>\n`;
      });

      // Slides generieren
      let slidesHTML = '';
      slides.forEach((slide, i) => {
        let buttonsHTML = '';
        if (slide.button1Link && slide.button1Text) {
          buttonsHTML += `          <a href="${slide.button1Link}" class="hero-slide-button">${slide.button1Text}</a>\n`;
        }
        if (slide.button2Link && slide.button2Text) {
          buttonsHTML += `          <a href="${slide.button2Link}" class="hero-slide-button hero-slide-button--secondary">${slide.button2Text}</a>\n`;
        }

        // Media element(s)
        let mediaHTML = '';
        if (slide.mediaType === 'parallax') {
          const layers = slide.layers || [];
          layers.forEach((layer, layerIndex) => {
            if (layer && layer.trim()) {
              const depth = (layerIndex + 1) * 0.15;
              mediaHTML += `        <img src="${layer}" class="hero-slide-layer" data-depth="${depth.toFixed(2)}" style="z-index:${layerIndex + 1};" alt="">\n`;
            }
          });
        } else if (slide.mediaType === 'video') {
          mediaHTML = `        <video src="${slide.image || ''}" class="hero-slide-media hero-slide-video" autoplay loop muted playsinline></video>`;
        } else {
          mediaHTML = `        <img src="${slide.image || ''}" alt="${slide.title || ''}" class="hero-slide-media hero-slide-image">`;
        }

        slidesHTML += `
      <!-- Slide ${i + 1} -->
      <div class="hero-slide" data-media-type="${slide.mediaType || 'image'}">
${mediaHTML}
        <div class="hero-slide-content">
          <h2 class="hero-slide-title">${slide.title || ''}</h2>
          <p class="hero-slide-description">
            ${slide.description || ''}
          </p>
${buttonsHTML.trimEnd()}
        </div>
      </div>
`;
      });

      return `<style>
  /* HERO SLIDER - WordPress/Elementor Compatible with Parallax Layers */
  .hero-slider, .hero-slider * { box-sizing: border-box !important; margin: 0 !important; padding: 0 !important; }
  .hero-slider { position: relative !important; width: 100vw !important; max-width: 100vw !important; height: calc(100vh - 120px) !important; min-height: 400px !important; overflow: hidden !important; display: block !important; margin-left: calc(-50vw + 50%) !important; }
  .hero-slider-track { display: flex !important; flex-wrap: nowrap !important; height: 100% !important; width: 100% !important; transition: transform 0.6s ease-in-out !important; gap: 0 !important; }
  .hero-slide { position: relative !important; min-width: 100% !important; width: 100% !important; height: 100% !important; flex-shrink: 0 !important; flex-grow: 0 !important; flex-basis: 100% !important; overflow: hidden !important; }
  .hero-slide-media { position: absolute !important; top: -5% !important; left: -5% !important; width: 110% !important; height: 110% !important; object-fit: cover !important; object-position: center center !important; display: block !important; transition: transform 0.15s ease-out !important; will-change: transform !important; }
  .hero-slide-layer { position: absolute !important; top: -5% !important; left: -5% !important; width: 110% !important; height: 110% !important; object-fit: cover !important; object-position: center center !important; display: block !important; transition: transform 0.15s ease-out !important; will-change: transform !important; }
  .hero-slide-video { object-position: center center !important; }
  .hero-slide-content { position: absolute !important; bottom: 80px !important; left: 5% !important; max-width: 45% !important; z-index: 20 !important; }
  .hero-slide-title { display: inline-block !important; background: #ffffff !important; color: #003366 !important; font-size: 2.5rem !important; font-weight: 700 !important; padding: 15px 25px !important; margin: 0 !important; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important; line-height: 1.2 !important; }
  .hero-slide-description { background: rgba(0, 40, 80, 0.85) !important; color: #ffffff !important; font-size: 1.1rem !important; line-height: 1.7 !important; padding: 20px 25px !important; margin: 0 !important; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important; }
  .hero-slide-button { display: inline-block !important; background: #0099cc !important; color: #ffffff !important; font-size: 1rem !important; font-weight: 600 !important; padding: 12px 28px !important; margin-top: 15px !important; margin-right: 10px !important; text-decoration: none !important; border-radius: 4px !important; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important; transition: background 0.3s, transform 0.2s !important; }
  .hero-slide-button:hover { background: #007aa3 !important; transform: translateY(-2px) !important; color: #ffffff !important; }
  .hero-slide-button--secondary { background: transparent !important; border: 2px solid #ffffff !important; }
  .hero-slide-button--secondary:hover { background: rgba(255, 255, 255, 0.2) !important; }
  .hero-nav-arrow { position: absolute !important; top: 50% !important; transform: translateY(-50%) !important; width: 60px !important; height: 100px !important; display: flex !important; align-items: center !important; justify-content: center !important; cursor: pointer !important; z-index: 30 !important; background: transparent !important; border: none !important; opacity: 0.8 !important; transition: opacity 0.3s !important; }
  .hero-nav-arrow:hover { opacity: 1 !important; }
  .hero-nav-arrow--prev { left: 20px !important; }
  .hero-nav-arrow--next { right: 20px !important; }
  .hero-nav-arrow svg { width: 30px !important; height: 60px !important; stroke: #ffffff !important; stroke-width: 3 !important; fill: none !important; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)) !important; }
  .hero-dots { position: absolute !important; bottom: 25px !important; left: 50% !important; transform: translateX(-50%) !important; display: flex !important; gap: 12px !important; z-index: 30 !important; flex-wrap: nowrap !important; }
  .hero-dot { width: 12px !important; height: 12px !important; min-width: 12px !important; min-height: 12px !important; max-width: 12px !important; max-height: 12px !important; border-radius: 50% !important; background: rgba(255, 255, 255, 0.5) !important; border: none !important; cursor: pointer !important; transition: background 0.3s, transform 0.2s !important; padding: 0 !important; flex-shrink: 0 !important; }
  .hero-dot:hover { background: rgba(255, 255, 255, 0.8) !important; transform: scale(1.15) !important; }
  .hero-dot.active { background: #ffffff !important; transform: scale(1.2) !important; }
  @media (max-width: 1024px) { .hero-slide-content { max-width: 60% !important; } .hero-slide-title { font-size: 2rem !important; } }
  @media (max-width: 768px) {
    .hero-slider { height: 75vh !important; min-height: 450px !important; }
    .hero-slide-content { left: 4% !important; right: 4% !important; bottom: 70px !important; max-width: none !important; }
    .hero-slide-title { font-size: 1.5rem !important; padding: 12px 18px !important; }
    .hero-slide-description { font-size: 1rem !important; line-height: 1.6 !important; padding: 16px 18px !important; }
    .hero-slide-button { padding: 10px 22px !important; font-size: 0.95rem !important; margin-top: 12px !important; }
    .hero-nav-arrow { width: 50px !important; height: 80px !important; }
    .hero-nav-arrow--prev { left: 8px !important; }
    .hero-nav-arrow--next { right: 8px !important; }
    .hero-nav-arrow svg { width: 24px !important; height: 48px !important; }
    .hero-dots { bottom: 18px !important; gap: 10px !important; }
    .hero-dot { width: 10px !important; height: 10px !important; min-width: 10px !important; min-height: 10px !important; max-width: 10px !important; max-height: 10px !important; }
  }
  @media (max-width: 480px) {
    .hero-slider { height: 70vh !important; min-height: 400px !important; }
    .hero-slide-content { bottom: 60px !important; left: 3% !important; right: 3% !important; }
    .hero-slide-title { font-size: 1.25rem !important; padding: 10px 14px !important; }
    .hero-slide-description { font-size: 0.9rem !important; padding: 14px 16px !important; line-height: 1.5 !important; }
    .hero-slide-button { padding: 10px 18px !important; font-size: 0.9rem !important; display: block !important; text-align: center !important; margin-right: 0 !important; }
    .hero-nav-arrow { width: 40px !important; height: 60px !important; }
    .hero-nav-arrow--prev { left: 5px !important; }
    .hero-nav-arrow--next { right: 5px !important; }
    .hero-nav-arrow svg { width: 20px !important; height: 40px !important; stroke-width: 2.5 !important; }
    .hero-dots { bottom: 12px !important; gap: 8px !important; }
    .hero-dot { width: 8px !important; height: 8px !important; min-width: 8px !important; min-height: 8px !important; max-width: 8px !important; max-height: 8px !important; }
  }
</style>

<div class="hero-slider">
  <button class="hero-nav-arrow hero-nav-arrow--prev" onclick="changeSlide(-1)">
    <svg viewBox="0 0 30 60"><polyline points="25,5 5,30 25,55"></polyline></svg>
  </button>
  <button class="hero-nav-arrow hero-nav-arrow--next" onclick="changeSlide(1)">
    <svg viewBox="0 0 30 60"><polyline points="5,5 25,30 5,55"></polyline></svg>
  </button>
  <div class="hero-dots">
${dotsHTML}  </div>
  <div class="hero-slider-track">
${slidesHTML}
  </div>
</div>

<script>
(function() {
  var currentSlide = 0;
  var track = document.querySelector('.hero-slider-track');
  var slides = document.querySelectorAll('.hero-slide');
  var dots = document.querySelectorAll('.hero-dot');
  var slider = document.querySelector('.hero-slider');
  var totalSlides = slides.length;
  var autoplayInterval = null;
  var isPaused = false;

  function updateDots() {
    for (var i = 0; i < dots.length; i++) {
      if (i === currentSlide) { dots[i].classList.add('active'); }
      else { dots[i].classList.remove('active'); }
    }
  }

  function goToSlide(index) {
    if (index < 0) { currentSlide = totalSlides - 1; }
    else if (index >= totalSlides) { currentSlide = 0; }
    else { currentSlide = index; }
    track.style.transform = 'translateX(-' + (currentSlide * 100) + '%)';
    updateDots();
  }

  function stopAutoplay() {
    if (autoplayInterval !== null) { clearInterval(autoplayInterval); autoplayInterval = null; }
  }

  function startAutoplay() {
    stopAutoplay();
    if (!isPaused) { autoplayInterval = setInterval(function() { goToSlide(currentSlide + 1); }, 5000); }
  }

  window.changeSlide = function(direction) { goToSlide(currentSlide + direction); startAutoplay(); };
  window.goToSlideManual = function(index) { goToSlide(index); startAutoplay(); };

  slider.onmouseenter = function() { isPaused = true; stopAutoplay(); };
  slider.onmouseleave = function() {
    isPaused = false; startAutoplay();
    // Reset all transforms
    var allLayers = document.querySelectorAll('.hero-slide-layer');
    var allMedia = document.querySelectorAll('.hero-slide-media');
    for (var i = 0; i < allLayers.length; i++) { allLayers[i].style.transform = 'translate(0, 0)'; }
    for (var i = 0; i < allMedia.length; i++) { allMedia[i].style.transform = 'translate(0, 0) scale(1)'; }
  };

  slider.onmousemove = function(e) {
    var rect = slider.getBoundingClientRect();
    var x = (e.clientX - rect.left) / rect.width - 0.5;
    var y = (e.clientY - rect.top) / rect.height - 0.5;
    applyParallax(x, y);
  };

  function applyParallax(x, y) {
    var currentSlideEl = slides[currentSlide];
    if (currentSlideEl) {
      var mediaType = currentSlideEl.getAttribute('data-media-type');
      if (mediaType === 'parallax') {
        var layers = currentSlideEl.querySelectorAll('.hero-slide-layer');
        for (var i = 0; i < layers.length; i++) {
          var depth = parseFloat(layers[i].getAttribute('data-depth')) || 0.3;
          var moveX = x * 50 * depth;
          var moveY = y * 35 * depth;
          layers[i].style.transform = 'translate(' + moveX + 'px, ' + moveY + 'px)';
        }
      } else {
        var media = currentSlideEl.querySelector('.hero-slide-media');
        if (media) { media.style.transform = 'translate(' + (x * -20) + 'px, ' + (y * -15) + 'px) scale(1.02)'; }
      }
    }
  }

  // Touch swipe support for slide navigation
  var touchStartX = 0;
  var touchStartY = 0;
  var touchStartTime = 0;
  slider.addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
    touchStartTime = Date.now();
  }, { passive: true });

  slider.addEventListener('touchend', function(e) {
    var touchEndX = e.changedTouches[0].screenX;
    var diff = touchStartX - touchEndX;
    var timeDiff = Date.now() - touchStartTime;
    if (Math.abs(diff) > 50 && timeDiff < 300) {
      if (diff > 0) { changeSlide(1); } else { changeSlide(-1); }
    }
  }, { passive: true });

  // Touch-based parallax (drag to move layers)
  var isTouching = false;
  var touchCenterX = 0;
  var touchCenterY = 0;
  slider.addEventListener('touchstart', function(e) {
    isTouching = true;
    var rect = slider.getBoundingClientRect();
    touchCenterX = rect.left + rect.width / 2;
    touchCenterY = rect.top + rect.height / 2;
  }, { passive: true });

  slider.addEventListener('touchmove', function(e) {
    if (!isTouching) return;
    var touch = e.changedTouches[0];
    var rect = slider.getBoundingClientRect();
    var x = (touch.clientX - rect.left) / rect.width - 0.5;
    var y = (touch.clientY - rect.top) / rect.height - 0.5;
    applyParallax(x * 1.5, y * 1.5);
  }, { passive: true });

  slider.addEventListener('touchend', function() {
    isTouching = false;
    // Smooth reset
    var allLayers = document.querySelectorAll('.hero-slide-layer');
    var allMedia = document.querySelectorAll('.hero-slide-media');
    for (var i = 0; i < allLayers.length; i++) { allLayers[i].style.transform = 'translate(0, 0)'; }
    for (var i = 0; i < allMedia.length; i++) { allMedia[i].style.transform = 'translate(0, 0) scale(1)'; }
  }, { passive: true });

  // Gyroscope parallax for mobile
  var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  if (isMobile && window.DeviceOrientationEvent) {
    var gyroEnabled = false;
    var initialBeta = null;
    var initialGamma = null;
    var gyroSupported = false;

    function handleOrientation(e) {
      if (e.gamma === null && e.beta === null) return;
      gyroSupported = true;
      if (!gyroEnabled) return;
      if (initialBeta === null) { initialBeta = e.beta || 0; initialGamma = e.gamma || 0; }
      var beta = (e.beta || 0) - initialBeta;
      var gamma = (e.gamma || 0) - initialGamma;
      var x = Math.max(-1, Math.min(1, gamma / 15));
      var y = Math.max(-1, Math.min(1, beta / 15));
      applyParallax(x, y);
    }

    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
      // iOS 13+ requires permission
      slider.addEventListener('click', function requestGyro() {
        DeviceOrientationEvent.requestPermission().then(function(state) {
          if (state === 'granted') { gyroEnabled = true; window.addEventListener('deviceorientation', handleOrientation, true); }
        }).catch(console.error);
        slider.removeEventListener('click', requestGyro);
      }, { once: true });
    } else {
      // Android and older iOS - enable directly
      gyroEnabled = true;
      window.addEventListener('deviceorientation', handleOrientation, true);
    }
  }

  startAutoplay();
})();
<\/script>`;
    }

    // Export Modal anzeigen
    function showExportModal() {
      document.getElementById('codeOutput').textContent = generateHTML();
      document.getElementById('exportModal').classList.add('active');
    }

    // Export Modal schlie√üen
    function closeExportModal() {
      document.getElementById('exportModal').classList.remove('active');
    }

    // Code kopieren
    function copyCode() {
      const code = generateHTML();
      navigator.clipboard.writeText(code).then(() => {
        showToast('Code kopiert!');
      });
    }

    // Als Datei speichern
    function downloadCode() {
      const code = generateHTML();
      const blob = new Blob([code], { type: 'text/html;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'slider.html';
      link.click();
      showToast('Datei heruntergeladen!');
    }

    // Toast anzeigen
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // Modal schlie√üen bei Klick au√üerhalb
    document.getElementById('exportModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('exportModal')) {
        closeExportModal();
      }
    });

    document.getElementById('loadModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('loadModal')) {
        closeLoadModal();
      }
    });

    document.getElementById('saveModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('saveModal')) {
        closeSaveModal();
      }
    });

    // Load Modal
    function showLoadModal() {
      document.getElementById('loadModal').classList.add('active');
    }

    function closeLoadModal() {
      document.getElementById('loadModal').classList.remove('active');
    }

    function loadFromStorageAndClose() {
      const saved = localStorage.getItem('aquaventus_slides');
      if (saved) {
        try {
          slides = JSON.parse(saved);
          // Backwards compatibility
          slides = slides.map(slide => ({
            ...slide,
            mediaType: slide.mediaType || 'image',
            layers: slide.layers || ['', '', '', '', '']
          }));
          renderSlideList();
          if (slides.length > 0) {
            selectSlide(0);
          }
          updatePreview();
          showToast('Projekt geladen!');
        } catch (e) {
          showToast('Fehler beim Laden');
        }
      } else {
        showToast('Kein gespeichertes Projekt gefunden');
      }
      closeLoadModal();
    }

    // Save Modal
    function showSaveModal() {
      document.getElementById('saveModal').classList.add('active');
    }

    function closeSaveModal() {
      document.getElementById('saveModal').classList.remove('active');
    }

    function saveToStorageAndClose() {
      localStorage.setItem('aquaventus_slides', JSON.stringify(slides));
      showToast('Im Browser gespeichert!');
      closeSaveModal();
    }

    function downloadProjectJSON() {
      const data = JSON.stringify(slides, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'slider_projekt.json';
      link.click();
      showToast('JSON-Datei heruntergeladen!');
      closeSaveModal();
    }

    function downloadProjectCSV() {
      // CSV Header
      const headers = ['Titel', 'Beschreibung', 'GrafikURL', 'MediaType', 'Link1', 'Link1Text', 'Link2', 'Link2Text', 'Layer1', 'Layer2', 'Layer3', 'Layer4', 'Layer5'];

      // Escape function for CSV values
      const escapeCSV = (val) => {
        if (val === null || val === undefined) return '';
        const str = String(val);
        if (str.includes(';') || str.includes('"') || str.includes('\n')) {
          return '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
      };

      // Build CSV rows
      let csv = headers.join(';') + '\n';

      slides.forEach(slide => {
        const layers = slide.layers || ['', '', '', '', ''];
        const row = [
          escapeCSV(slide.title || ''),
          escapeCSV(slide.description || ''),
          escapeCSV(slide.image || ''),
          escapeCSV(slide.mediaType || 'image'),
          escapeCSV(slide.button1Link || ''),
          escapeCSV(slide.button1Text || ''),
          escapeCSV(slide.button2Link || ''),
          escapeCSV(slide.button2Text || ''),
          escapeCSV(layers[0] || ''),
          escapeCSV(layers[1] || ''),
          escapeCSV(layers[2] || ''),
          escapeCSV(layers[3] || ''),
          escapeCSV(layers[4] || '')
        ];
        csv += row.join(';') + '\n';
      });

      // Download with BOM for Excel compatibility
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'slider_projekt.csv';
      link.click();
      showToast('CSV-Datei heruntergeladen!');
      closeSaveModal();
    }

    // Datei laden (JSON oder CSV)
    function handleFileLoad(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const content = e.target.result;

        if (file.name.endsWith('.json')) {
          try {
            slides = JSON.parse(content);
            // Backwards compatibility
            slides = slides.map(slide => ({
              ...slide,
              mediaType: slide.mediaType || 'image',
              layers: slide.layers || ['', '', '', '', '']
            }));
            renderSlideList();
            if (slides.length > 0) {
              selectSlide(0);
            }
            updatePreview();
            showToast('JSON geladen!');
          } catch (err) {
            showToast('Fehler beim Lesen der JSON-Datei');
          }
        } else if (file.name.endsWith('.csv')) {
          try {
            loadFromCSV(content);
            showToast('CSV geladen!');
          } catch (err) {
            showToast('Fehler beim Lesen der CSV-Datei');
          }
        }

        closeLoadModal();
      };
      reader.readAsText(file, 'UTF-8');

      // Reset input
      event.target.value = '';
    }

    // CSV laden
    function loadFromCSV(content) {
      const firstLine = content.split('\n')[0];
      let delimiter = ',';
      if (firstLine.includes('\t')) delimiter = '\t';
      else if (firstLine.includes(';')) delimiter = ';';

      const lines = content.trim().split('\n');
      const headers = lines[0].split(delimiter).map(h => h.trim().replace(/^["']|["']$/g, ''));

      slides = [];

      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;

        const values = parseCSVLine(lines[i], delimiter);
        const mediaTypeIndex = headers.indexOf('MediaType');
        const mediaTypeVal = mediaTypeIndex >= 0 ? values[mediaTypeIndex] : '';
        const slide = {
          id: Date.now() + i,
          title: values[headers.indexOf('Titel')] || '',
          description: values[headers.indexOf('Beschreibung')] || '',
          button1Link: values[headers.indexOf('Link1')] || '',
          button1Text: values[headers.indexOf('Link1Text')] || '',
          button2Link: values[headers.indexOf('Link2')] || '',
          button2Text: values[headers.indexOf('Link2Text')] || '',
          image: values[headers.indexOf('GrafikURL')] || '',
          mediaType: mediaTypeVal.toLowerCase() === 'video' ? 'video' :
                     mediaTypeVal.toLowerCase() === 'parallax' ? 'parallax' : 'image',
          layers: [
            values[headers.indexOf('Layer1')] || '',
            values[headers.indexOf('Layer2')] || '',
            values[headers.indexOf('Layer3')] || '',
            values[headers.indexOf('Layer4')] || '',
            values[headers.indexOf('Layer5')] || ''
          ]
        };
        slides.push(slide);
      }

      renderSlideList();
      if (slides.length > 0) {
        selectSlide(0);
      }
      updatePreview();
    }

    function parseCSVLine(line, delimiter) {
      const values = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"' && !inQuotes) {
          inQuotes = true;
        } else if (char === '"' && inQuotes) {
          if (line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = false;
          }
        } else if (char === delimiter && !inQuotes) {
          values.push(current.trim().replace(/^["']|["']$/g, ''));
          current = '';
        } else {
          current += char;
        }
      }
      values.push(current.trim().replace(/^["']|["']$/g, ''));
      return values;
    }
  </script>

</body>
</html>
